<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slovenia Normiranec Calculator 2025</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-focus: #2563eb;
            --badge-bg: #eff6ff;
            --badge-text: #1e40af;
            --danger: #dc2626;
            --success: #16a34a;
            --warning-bg: #fef2f2;
            --warning-text: #991b1b;
            --breach-bg: #450a0a;
            --breach-text: #fecaca;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #0f172a;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --border-focus: #60a5fa;
            --badge-bg: #172554;
            --badge-text: #dbeafe;
            --danger: #f87171;
            --success: #34d399;
            --warning-bg: #450a0a;
            --warning-text: #fca5a5;
            --breach-bg: #7f1d1d;
            --breach-text: #fecaca;
        }

        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            line-height: 1.5;
        }

        .container {
            background-color: var(--bg-card);
            width: 100%;
            max-width: 680px;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .header h1 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; }
        .controls { display: flex; gap: 8px; }
        .btn-icon {
            background: transparent; border: 1px solid var(--border); color: var(--text-main);
            padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-icon:hover { background: var(--border); }

        /* Mode Toggles */
        .mode-switch {
            display: flex; background: var(--border); padding: 4px; border-radius: 10px; margin-bottom: 1.5rem;
        }
        .mode-btn {
            flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: 600;
            color: var(--text-muted); border-radius: 8px; transition: 0.2s; font-size: 0.95rem;
        }
        .mode-btn.active {
            background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Inputs - Unified Style */
        .input-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;
        }
        @media (max-width: 600px) { .input-grid { grid-template-columns: 1fr; gap: 1rem; } }

        .form-group label {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);
        }

        .source-link {
            font-size: 0.75rem; color: var(--primary); text-decoration: none; font-weight: normal;
            background: var(--badge-bg); padding: 2px 6px; border-radius: 4px; transition: 0.2s;
        }
        .source-link:hover { text-decoration: underline; background: var(--border); }
        
        .form-control {
            width: 100%;
            height: 48px; 
            padding: 0 12px;
            border: 1px solid var(--border);
            background-color: var(--bg-input);
            color: var(--text-main);
            border-radius: 8px;
            font-size: 1rem;
            appearance: none; -webkit-appearance: none;
            transition: border-color 0.2s;
        }
        select.form-control {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            cursor: pointer;
        }
        .form-control:focus { outline: none; border-color: var(--primary); }

        #manual-base-wrapper { margin-top: 10px; display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Results */
        .results-card {
            background-color: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }
        .result-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.75rem; font-size: 0.95rem;
        }
        .result-row.sub {
            padding-left: 1rem; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted);
        }
        .result-row.total {
            margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--border);
            font-weight: 700; font-size: 1.2rem;
        }
        .result-row.summary {
            justify-content: flex-end; margin-top: 0.5rem;
            font-size: 0.85rem; color: var(--text-muted); text-align: right;
        }

        .val { font-family: 'Courier New', monospace; font-weight: 700; }
        .text-red { color: var(--danger); }
        .text-green { color: var(--success); }
        .badge {
            background-color: var(--badge-bg); color: var(--badge-text);
            font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; margin-left: 8px; vertical-align: middle;
        }
        
        /* Alerts */
        .limit-alert {
            margin-top: 1rem; padding: 15px; border-radius: 8px;
            background-color: var(--warning-bg); color: var(--warning-text);
            font-size: 0.9rem; font-weight: 600; display: none; border: 1px solid var(--warning-text);
            line-height: 1.4;
        }
        .limit-alert.breach {
            background-color: var(--breach-bg); color: var(--breach-text);
            border: 1px solid var(--danger); animation: shake 0.5s;
        }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        /* Docs */
        .docs { margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem; }
        details { cursor: pointer; color: var(--text-muted); margin-bottom: 10px; }
        summary { font-weight: 600; margin-bottom: 0.5rem; outline: none; }
        details[open] summary { color: var(--primary); }
        .doc-content { font-size: 0.9rem; line-height: 1.6; padding-left: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border); }
        .doc-content h4 { margin: 1rem 0 0.5rem 0; color: var(--text-main); }
        .doc-content ul { padding-left: 1.2rem; margin: 0.5rem 0; }
        .doc-content li { margin-bottom: 0.3rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 data-t="title">Normiranec 2025</h1>
        <div class="controls">
            <button class="btn-icon" onclick="toggleLang()" id="btn-lang">SL</button>
            <button class="btn-icon" onclick="toggleTheme()" id="btn-theme">üåó</button>
        </div>
    </div>

    <!-- Mode Toggles -->
    <div class="mode-switch">
        <div class="mode-btn active" onclick="setMode('polni')" id="tab-polni">
            <span data-t="full_sp">Polni S.P.</span>
        </div>
        <div class="mode-btn" onclick="setMode('pop')" id="tab-pop">
            <span data-t="pop_sp">Popoldanski S.P.</span>
        </div>
    </div>

    <!-- Main Inputs -->
    <div class="input-grid">
        <div class="form-group">
            <label data-t="label_revenue">Letni prihodki (‚Ç¨)</label>
            <input type="number" id="revenue" class="form-control" value="65000" step="5000" oninput="calc()">
        </div>
        <div class="form-group">
            <label>
                <span data-t="label_salary">Povpreƒçna bruto plaƒça 2024 (‚Ç¨)</span>
                <!-- Source Link Added Here -->
                <a href="https://www.stat.si/StatWeb/Field/Index/15" target="_blank" class="source-link" title="Statistiƒçni urad RS">
                    SURS &#8599;
                </a>
            </label>
            <input type="number" id="avg-salary" class="form-control" value="2395" step="50" oninput="calc()">
        </div>
    </div>

    <!-- Polni Settings -->
    <div class="input-grid" id="polni-settings">
        <div class="form-group">
            <label data-t="label_status">Status (Prispevki)</label>
            <select id="status" class="form-control" onchange="calc()">
                <option value="reg" data-t="opt_reg">Redni zavezanec</option>
                <option value="y1" data-t="opt_y1">1. leto (-50% PIZ)</option>
                <option value="y2" data-t="opt_y2">2. leto (-30% PIZ)</option>
            </select>
        </div>
        <div class="form-group">
            <label data-t="label_base">Osnova za prispevke</label>
            <select id="base-type" class="form-control" onchange="toggleManualBase()">
                <option value="auto" data-t="opt_real">Po dobiƒçku (Avtomatsko)</option>
                <option value="min" data-t="opt_min">Minimalni prispevki</option>
                <option value="manual" data-t="opt_man">Roƒçni vnos</option>
            </select>
            <div id="manual-base-wrapper">
                <input type="number" id="base-manual" class="form-control" placeholder="Vpi≈°ite osnovo (npr. 2000)" step="50" oninput="calc()">
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="results-card">
        <div class="result-row">
            <span>
                <span data-t="res_expenses">Priznani stro≈°ki</span>
                <span id="badge-exp" class="badge">80% / 0%</span>
            </span>
            <span class="val" id="out-exp">0.00 ‚Ç¨</span>
        </div>
        <div class="result-row">
            <span data-t="res_base">Davƒçna osnova</span>
            <span class="val" id="out-base">0.00 ‚Ç¨</span>
        </div>
        <div class="result-row">
            <span data-t="res_tax">Dohodnina</span>
            <span class="val text-red" id="out-tax">0.00 ‚Ç¨</span>
        </div>
        
        <hr style="border:0; border-top:1px dashed var(--border); margin: 1rem 0;">

        <div class="result-row">
            <span data-t="res_soc">Meseƒçni prispevki</span>
            <span class="val text-red" id="out-soc-mo">0.00 ‚Ç¨</span>
        </div>
        
        <div class="result-row sub">
            <span data-t="det_base">Osnova (Bruto):</span>
            <span class="val" id="out-ins-base">0.00 ‚Ç¨</span>
        </div>
        <div class="result-row sub">
            <span>PIZ + ZZ + Star≈° + Zap:</span>
            <span class="val" id="out-main">0.00 ‚Ç¨</span>
        </div>
        <div class="result-row sub">
            <span>Dolg. oskrba (2%) <span class="badge">2025</span>:</span>
            <span class="val" id="out-do">0.00 ‚Ç¨</span>
        </div>
        <div class="result-row sub" id="row-ozp">
            <span>OZP (Fiksni) <span class="badge">FURS</span>:</span>
            <span class="val" id="out-ozp">35.00 ‚Ç¨</span>
        </div>

        <div class="result-row total">
            <span data-t="res_net">Neto (Letno)</span>
            <span class="val text-green" id="out-net">0.00 ‚Ç¨</span>
        </div>

        <div class="result-row summary">
            <span>
                <span data-t="lbl_total_tax">Skupaj dajatve (Davek + Prispevki):</span> 
                <strong id="out-total-paid">0.00 ‚Ç¨</strong> 
                (<span id="out-effective-rate">0.0%</span>)
            </span>
        </div>
    </div>

    <!-- Limit Warning -->
    <div id="alert-box" class="limit-alert"></div>

    <!-- Documentation -->
    <div class="docs">
        <details>
            <summary data-t="doc_title">Kako deluje normirani S.P. v 2025?</summary>
            <div class="doc-content">
                <h4 data-t="doc_h_polni">Polni S.P.</h4>
                <p data-t="doc_p_polni">S.P. je edina zaposlitev.</p>
                <ul>
                    <li data-t="doc_li_p1"><strong>Limit:</strong> 120.000 ‚Ç¨ letno (min. 9 mesecev zavarovanja).</li>
                    <li data-t="doc_li_p2"><strong>Stro≈°ki:</strong> 80% do 60.000 ‚Ç¨, 0% od 60k do 120k.</li>
                    <li><strong>Prekoraƒçitev:</strong> ƒåe prese≈æete 120.000 ‚Ç¨, izgubite status in se obdavƒçite po realnih stro≈°kih (ali ocena 35%). Ponoven vstop ni mo≈æen 5 let.</li>
                </ul>
                <h4 data-t="doc_h_pop">Popoldanski S.P.</h4>
                <p data-t="doc_p_pop">Ob redni zaposlitvi.</p>
                <ul>
                    <li data-t="doc_li_pop1"><strong>Limit:</strong> 50.000 ‚Ç¨.</li>
                    <li data-t="doc_li_pop2"><strong>Stro≈°ki:</strong> 80% do 12.500 ‚Ç¨, 40% do 50k ‚Ç¨.</li>
                    <li><strong>Prekoraƒçitev:</strong> Izguba statusa nad 50.000 ‚Ç¨. Obdavƒçitev po lestvici.</li>
                </ul>
            </div>
        </details>
        <details>
            <summary data-t="doc_soc_title">Kaj pomenijo prispevki & popusti?</summary>
            <div class="doc-content">
                <h4 data-t="doc_soc_new">Prvi vpis v register (Popusti)</h4>
                <p data-t="doc_soc_p1">Dr≈æava pomaga pri plaƒçilu PIZ (pokojnina) prvo in drugo leto.</p>
                <ul>
                    <li data-t="doc_soc_li1"><strong>1. leto:</strong> 50% popust na PIZ.</li>
                    <li data-t="doc_soc_li2"><strong>2. leto:</strong> 30% popust na PIZ.</li>
                </ul>
                <p><em>* Popust velja le za PIZ (pokojnino), zdravstveno zavarovanje (ZZ) plaƒçate v celoti.</em></p>
                <h4 data-t="doc_soc_type">Vrste prispevkov</h4>
                <ul>
                    <li><strong>PIZ:</strong> Pokojninsko in invalidsko (najveƒçji del).</li>
                    <li><strong>ZZ:</strong> Zdravstveno zavarovanje.</li>
                    <li><strong>Star≈°evsko/Zaposlovanje:</strong> Manj≈°i prispevki.</li>
                    <li><strong>DO (Novo 2025):</strong> Dolgotrajna oskrba (2% od osnove).</li>
                </ul>
            </div>
        </details>
    </div>
</div>

<script>
    const CONFIG = {
        polni: {
            limit: 120000,
            tier1: 60000,
            tier1_rate: 0.80,
            tier2_rate: 0.00,
            ozp: 35.00
        },
        pop: {
            limit: 50000,
            tier1: 12500,
            tier1_rate: 0.80,
            tier2_rate: 0.40,
            fixed_contrib: 105.75
        },
        rates: {
            piz: 0.2435, zz: 0.1292, parent: 0.0020, emp: 0.0020, do: 0.0200
        },
        breach_tax_rate: 0.35
    };

    const TEXT = {
        sl: {
            title: "Normiranec 2025",
            full_sp: "Polni S.P.",
            pop_sp: "Popoldanski S.P.",
            label_revenue: "Letni prihodki (‚Ç¨)",
            label_salary: "Povpreƒçna bruto plaƒça 2024 (‚Ç¨)",
            label_status: "Status (Popust)",
            label_base: "Osnova za prispevke",
            opt_reg: "Redni (brez popusta)",
            opt_y1: "1. leto (-50% PIZ)",
            opt_y2: "2. leto (-30% PIZ)",
            opt_real: "Po dobiƒçku (Avtomatsko)",
            opt_min: "Minimalni prispevki",
            opt_man: "Roƒçni vnos",
            res_expenses: "Priznani stro≈°ki",
            res_base: "Davƒçna osnova",
            res_tax: "Dohodnina",
            res_soc: "Meseƒçni prispevki",
            res_net: "Neto (Letno)",
            det_base: "Osnova (Bruto):",
            lbl_total_tax: "Skupaj dajatve (Davek + Prispevki):",
            alert_limit: "‚ö†Ô∏è OPOZORILO: Presegate limit {limit} ‚Ç¨ za {mode}!",
            alert_breach: "‚õî IZGUBA STATUSA: Presegli ste {limit} ‚Ç¨! Obdavƒçitev ocenjena na 35%. Status normiranca izgubite in ga ne morete obnoviti 5 let.",
            doc_title: "Kako deluje sistem v 2025? (Klikni za info)",
            doc_h_polni: "Polni S.P.",
            doc_p_polni: "Glavna dejavnost, polno zavarovanje.",
            doc_li_p1: "Limit: 120.000 ‚Ç¨ (obvezno zavarovanje vsaj 9 mesecev).",
            doc_li_p2: "Stro≈°ki: 80% do 60k ‚Ç¨, nad tem 0%.",
            doc_h_pop: "Popoldanski S.P.",
            doc_p_pop: "Ob redni zaposlitvi.",
            doc_li_pop1: "Limit: 50.000 ‚Ç¨.",
            doc_li_pop2: "Stro≈°ki: 80% do 12.5k ‚Ç¨, 40% do 50k ‚Ç¨.",
            doc_soc_title: "Pojasnilo prispevkov in popustov",
            doc_soc_new: "Prvi vpis (Newbie popust)",
            doc_soc_p1: "Dr≈æava pomaga pri plaƒçilu PIZ (pokojnina) prvo in drugo leto.",
            doc_soc_li1: "1. leto: 50% popust na PIZ.",
            doc_soc_li2: "2. leto: 30% popust na PIZ.",
            doc_soc_type: "Kaj plaƒçujem?"
        },
        en: {
            title: "Slovenia Tax Calc 2025",
            full_sp: "Full-time S.P.",
            pop_sp: "Afternoon S.P.",
            label_revenue: "Annual Revenue (‚Ç¨)",
            label_salary: "Avg Gross Salary 2024 (‚Ç¨)",
            label_status: "Status (Discount)",
            label_base: "Contribution Base",
            opt_reg: "Regular (No discount)",
            opt_y1: "1st Year (-50% Pension)",
            opt_y2: "2nd Year (-30% Pension)",
            opt_real: "Automatic (Profit based)",
            opt_min: "Minimum Statutory",
            opt_man: "Manual Input",
            res_expenses: "Recognized Expenses",
            res_base: "Tax Base",
            res_tax: "Income Tax",
            res_soc: "Monthly Contributions",
            res_net: "Net Profit",
            det_base: "Base (Gross):",
            lbl_total_tax: "Total Paid (Tax + Contrib):",
            alert_limit: "‚ö†Ô∏è WARNING: You exceed the {limit} ‚Ç¨ limit for {mode}!",
            alert_breach: "‚õî STATUS LOST: You exceeded {limit} ‚Ç¨! Tax estimated at 35%. You lose 'normirani' status and cannot return for 5 years.",
            doc_title: "How does it work in 2025? (Click to expand)",
            doc_h_polni: "Full S.P. (Polni)",
            doc_p_polni: "Main employment activity.",
            doc_li_p1: "Limit: 120,000 ‚Ç¨.",
            doc_li_p2: "Expenses: 80% up to 60k, 0% above.",
            doc_h_pop: "Afternoon S.P.",
            doc_p_pop: "Side hustle.",
            doc_li_pop1: "Limit: 50,000 ‚Ç¨.",
            doc_li_pop2: "Expenses: 80% up to 12.5k, 40% up to 50k.",
            doc_soc_title: "Social Contributions & Discounts",
            doc_soc_new: "First Entry (New Business)",
            doc_soc_p1: "State subsidizes Pension (PIZ) contributions for the first 2 years.",
            doc_soc_li1: "1st Year: 50% discount on PIZ.",
            doc_soc_li2: "2nd Year: 30% discount on PIZ.",
            doc_soc_type: "Breakdown"
        }
    };

    let state = { mode: 'polni', lang: 'sl', theme: 'light' };

    function init() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            state.theme = 'dark';
            applyTheme();
        }
        calc();
    }

    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        applyTheme();
    }
    function applyTheme() { document.documentElement.setAttribute('data-theme', state.theme); }

    function toggleLang() {
        state.lang = state.lang === 'sl' ? 'en' : 'sl';
        document.getElementById('btn-lang').innerText = state.lang.toUpperCase();
        document.querySelectorAll('[data-t]').forEach(el => {
            const key = el.getAttribute('data-t');
            if (TEXT[state.lang][key]) el.innerText = TEXT[state.lang][key];
        });
        calc();
    }

    function setMode(mode) {
        state.mode = mode;
        document.getElementById('tab-polni').className = mode === 'polni' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('tab-pop').className = mode === 'pop' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('polni-settings').style.display = mode === 'polni' ? 'grid' : 'none';
        document.getElementById('row-ozp').style.display = mode === 'polni' ? 'flex' : 'none';
        calc();
    }

    function toggleManualBase() {
        const type = document.getElementById('base-type').value;
        document.getElementById('manual-base-wrapper').style.display = type === 'manual' ? 'block' : 'none';
        calc();
    }

    function fmt(n) {
        return n.toLocaleString(state.lang === 'sl' ? 'sl-SI' : 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
    }

    function calc() {
        const rev = parseFloat(document.getElementById('revenue').value) || 0;
        const avgSal = parseFloat(document.getElementById('avg-salary').value) || 2395;

        let expenses = 0;
        let limit = 0;
        let badgeText = "";
        let isBreach = false;

        if (state.mode === 'polni') {
            limit = CONFIG.polni.limit;
            if (rev > limit) {
                isBreach = true;
                expenses = 0;
                badgeText = "0% (Limit)";
            } else {
                badgeText = "80% / 0%";
                const t1 = Math.min(rev, CONFIG.polni.tier1);
                expenses = t1 * CONFIG.polni.tier1_rate;
            }
        } else {
            limit = CONFIG.pop.limit;
            if (rev > limit) {
                isBreach = true;
                expenses = 0;
                badgeText = "0% (Limit)";
            } else {
                badgeText = "80% / 40%";
                const t1 = Math.min(rev, CONFIG.pop.tier1);
                expenses += t1 * CONFIG.pop.tier1_rate;
                if (rev > CONFIG.pop.tier1) {
                    const remainder = Math.min(rev, CONFIG.pop.limit) - CONFIG.pop.tier1;
                    expenses += Math.max(0, remainder * CONFIG.pop.tier2_rate);
                }
            }
        }

        const profit = Math.max(0, rev - expenses);
        let tax = isBreach ? profit * CONFIG.breach_tax_rate : profit * 0.20;

        let moTotal = 0;
        let cBase = 0;
        let cMain = 0;
        let cDo = 0;
        let cOzp = 0;

        if (state.mode === 'pop') {
            moTotal = CONFIG.pop.fixed_contrib;
            cMain = 49.15 + 50.63; 
            cDo = 5.97;
        } else {
            cOzp = CONFIG.polni.ozp;
            const minBase = 0.60 * avgSal;
            const maxBase = 3.50 * avgSal;
            const rateSum = CONFIG.rates.piz + CONFIG.rates.zz + CONFIG.rates.parent + CONFIG.rates.emp + CONFIG.rates.do;
            const baseMethod = document.getElementById('base-type').value;

            if (baseMethod === 'min') {
                cBase = minBase;
            } else if (baseMethod === 'manual') {
                const manVal = parseFloat(document.getElementById('base-manual').value) || 0;
                cBase = manVal === 0 ? minBase : Math.min(Math.max(manVal, minBase), maxBase);
            } else {
                const denom = 12 - (9 * rateSum);
                cBase = denom > 0 ? (profit * 0.75) / denom : maxBase;
                cBase = Math.min(Math.max(cBase, minBase), maxBase);
            }

            let rawPiz = cBase * CONFIG.rates.piz;
            const rawOther = cBase * (CONFIG.rates.zz + CONFIG.rates.parent + CONFIG.rates.emp);
            const rawDo = cBase * CONFIG.rates.do;

            const status = document.getElementById('status').value;
            if (status === 'y1') rawPiz *= 0.5;
            if (status === 'y2') rawPiz *= 0.7;

            cMain = rawPiz + rawOther;
            cDo = rawDo;
            moTotal = cMain + cDo + cOzp;
        }

        const annSoc = moTotal * 12;
        const net = rev - tax - annSoc;
        const totalPaid = tax + annSoc;
        const effectiveRate = rev > 0 ? (totalPaid / rev) * 100 : 0;

        document.getElementById('badge-exp').innerText = badgeText;
        document.getElementById('out-exp').innerText = fmt(expenses);
        document.getElementById('out-base').innerText = fmt(profit);
        
        const taxEl = document.getElementById('out-tax');
        taxEl.innerText = fmt(tax);
        if (isBreach) taxEl.innerHTML += ` <span class="badge" style="background:#450a0a; color:#fff">35%</span>`;

        document.getElementById('out-soc-mo').innerText = fmt(moTotal);
        document.getElementById('out-ins-base').innerText = fmt(cBase);
        document.getElementById('out-main').innerText = fmt(cMain);
        document.getElementById('out-do').innerText = fmt(cDo);
        
        document.getElementById('out-net').innerText = fmt(net);
        document.getElementById('out-total-paid').innerText = fmt(totalPaid);
        document.getElementById('out-effective-rate').innerText = effectiveRate.toFixed(1) + '%';

        const alertBox = document.getElementById('alert-box');
        if (isBreach) {
            alertBox.style.display = 'block';
            alertBox.className = 'limit-alert breach';
            let msg = TEXT[state.lang].alert_breach.replace('{limit}', limit.toLocaleString());
            alertBox.innerText = msg;
        } else {
            alertBox.style.display = 'none';
        }
    }

    init();
</script>
</body>
</html>
